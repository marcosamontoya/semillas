import React, { useEffect, useRef, useState } from "react";

// Componente React que reproduce la funcionalidad del HTML original
// y evita errores si el archivo se interpreta como un archivo .tsx / React.
// Uso: pegar este componente en un proyecto React/Next y renderizar <MapPage />.

export default function MapPage() {
  const mapRef = useRef(null);
  const containerRef = useRef(null);
  const [loaded, setLoaded] = useState(false);
  const [markersCount, setMarkersCount] = useState(0);

  const storageKey = "map_markers_v1_html";

  useEffect(() => {
    // Cargar Leaflet CSS si no está presente
    if (!document.querySelector("link[data-leaflet]")) {
      const l = document.createElement("link");
      l.rel = "stylesheet";
      l.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
      l.setAttribute("data-leaflet", "1");
      document.head.appendChild(l);
    }

    // Cargar Leaflet JS si no está presente
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        if (window.L) return resolve(window.L);
        const s = document.createElement("script");
        s.src = src;
        s.async = true;
        s.onload = () => resolve(window.L);
        s.onerror = reject;
        document.body.appendChild(s);
      });
    }

    let cancelled = false;

    (async () => {
      try {
        await loadScript("https://unpkg.com/leaflet@1.9.4/dist/leaflet.js");
        if (cancelled) return;

        // inicializar mapa
        const L = window.L;
        if (!containerRef.current) return;

        // create map only once
        if (!mapRef.current) {
          mapRef.current = L.map(containerRef.current).setView([-34.6037, -58.3816], 13);

          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: "&copy; OpenStreetMap contributors",
          }).addTo(mapRef.current);
        }

        // helper: svg icons
        const svgColmena = encodeURIComponent(
          "<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'><path fill='%23F59E0B' d='M12 2C8.13 2 5 5.13 5 9c0 3.87 7 13 7 13s7-9.13 7-13c0-3.87-3.13-7-7-7z'/></svg>"
        );
        const svgParcela = encodeURIComponent(
          "<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 24 24'><rect rx='4' ry='4' width='20' height='14' x='2' y='5' fill='%239CA3AF'/></svg>"
        );

        const iconColmena = L.icon({
          iconUrl: "data:image/svg+xml;utf8," + svgColmena,
          iconSize: [28, 28],
          iconAnchor: [14, 28],
          popupAnchor: [0, -24],
        });
        const iconParcela = L.icon({
          iconUrl: "data:image/svg+xml;utf8," + svgParcela,
          iconSize: [28, 28],
          iconAnchor: [14, 28],
          popupAnchor: [0, -24],
        });

        // markers store
        const markerObjs = [];

        function saveAllLocal() {
          const data = markerObjs.map((m) => ({
            id: m._id,
            type: m.type,
            label: m.label,
            lat: m.getLatLng().lat,
            lng: m.getLatLng().lng,
            createdAt: m.createdAt,
          }));
          localStorage.setItem(storageKey, JSON.stringify(data));
          setMarkersCount(data.length);
        }

        function renderPopupContent(marker) {
          const div = document.createElement("div");
          div.style.minWidth = "180px";
          const title = document.createElement("strong");
          title.textContent = marker.label;
          div.appendChild(title);
          const ttype = document.createElement("div");
          ttype.className = "small";
          ttype.textContent = marker.type;
          div.appendChild(ttype);
          const lat = document.createElement("div");
          lat.style.marginTop = "6px";
          lat.textContent = "Lat: " + marker.getLatLng().lat.toFixed(6);
          div.appendChild(lat);
          const lng = document.createElement("div");
          lng.textContent = "Lng: " + marker.getLatLng().lng.toFixed(6);
          div.appendChild(lng);
          const actions = document.createElement("div");
          actions.style.marginTop = "8px";
          actions.style.display = "flex";
          actions.style.gap = "8px";
          const btnDel = document.createElement("button");
          btnDel.className = "btn";
          btnDel.textContent = "Eliminar";
          btnDel.onclick = () => {
            if (confirm("Eliminar este marcador?")) {
              removeMarker(marker._id);
            }
          };
          actions.appendChild(btnDel);
          div.appendChild(actions);
          return div;
        }

        function addMarkerToMap(data, persist = true) {
          const ic = data.type === "colmena" ? iconColmena : iconParcela;
          const m = L.marker([data.lat, data.lng], { icon: ic }).addTo(mapRef.current);
          m.type = data.type;
          m.label = data.label || (data.type === "colmena" ? "colmena" : "parcela no identificada");
          m.createdAt = data.createdAt || new Date().toISOString();
          m._id = data.id || Date.now() + Math.floor(Math.random() * 1000);
          m.bindPopup(renderPopupContent(m));
          m.on("click", () => m.openPopup());
          markerObjs.push(m);
          if (persist) saveAllLocal();
          refreshListUI();
          return m;
        }

        function removeMarker(id) {
          const idx = markerObjs.findIndex((x) => x._id === id);
          if (idx !== -1) {
            mapRef.current.removeLayer(markerObjs[idx]);
            markerObjs.splice(idx, 1);
            saveAllLocal();
            refreshListUI();
          }
        }

        function refreshListUI() {
          // actualiza conteo reactivo
          setMarkersCount(markerObjs.length);

          const list = document.getElementById("markerList-react");
          if (!list) return;
          list.innerHTML = "";
          if (markerObjs.length === 0) {
            list.innerHTML = "<div class='small' style='margin-top:6px'>(sin marcadores)</div>";
            return;
          }
          markerObjs.forEach((m) => {
            const item = document.createElement("div");
            item.className = "marker-item";
            const left = document.createElement("div");
            left.innerHTML = "<strong>" + escapeHtml(m.label) + "</strong><div class='small'>" + escapeHtml(m.type) + "</div>";
            const right = document.createElement("div");
            right.className = "marker-actions";
            const btnZoom = document.createElement("button");
            btnZoom.className = "btn";
            btnZoom.textContent = "Ir";
            btnZoom.onclick = () => {
              mapRef.current.setView(m.getLatLng(), 16);
              m.openPopup();
            };
            const btnDel = document.createElement("button");
            btnDel.className = "btn";
            btnDel.textContent = "Eliminar";
            btnDel.onclick = () => {
              if (confirm("Eliminar este marcador?")) removeMarker(m._id);
            };
            right.appendChild(btnZoom);
            right.appendChild(btnDel);
            item.appendChild(left);
            item.appendChild(right);
            item.style.display = "flex";
            item.style.justifyContent = "space-between";
            item.style.alignItems = "center";
            list.appendChild(item);
          });
        }

        function escapeHtml(s) {
          return String(s)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        // load persisted markers
        try {
          const raw = localStorage.getItem(storageKey);
          if (raw) {
            const arr = JSON.parse(raw);
            if (Array.isArray(arr)) {
              arr.forEach((a) => addMarkerToMap(a, false));
            }
          }
        } catch (e) {
          console.error("error loading local markers", e);
        }

        // click handler to open modal-like small UI
        let pendingLatLng = null;

        mapRef.current.on("click", function (e) {
          pendingLatLng = e.latlng;
          const coordsText = document.getElementById("coordsText-react");
          const labelInput = document.getElementById("labelInput-react");
          const modal = document.getElementById("addModal-react");
          if (!coordsText || !labelInput || !modal) return;
          coordsText.textContent = "Lat: " + e.latlng.lat.toFixed(6) + " — Lng: " + e.latlng.lng.toFixed(6);
          labelInput.value = "";
          const defaultRadio = document.querySelector('input[name="type-react"][value="colmena"]');
          if (defaultRadio) defaultRadio.checked = true;
          modal.style.display = "block";
        });

        // attach handlers for reactified controls
        document.getElementById("cancelAdd-react").addEventListener("click", () => {
          const modal = document.getElementById("addModal-react");
          if (modal) modal.style.display = "none";
          pendingLatLng = null;
        });

        document.getElementById("saveAdd-react").addEventListener("click", () => {
          if (!pendingLatLng) return;
          const type = document.querySelector('input[name="type-react"]:checked').value;
          const label = (document.getElementById("labelInput-react").value || "").trim() || (type === "colmena" ? "colmena" : "parcela no identificada");
          const data = {
            id: Date.now() + Math.floor(Math.random() * 1000),
            type,
            label,
            lat: pendingLatLng.lat,
            lng: pendingLatLng.lng,
            createdAt: new Date().toISOString(),
          };
          addMarkerToMap(data, true);
          const modal = document.getElementById("addModal-react");
          if (modal) modal.style.display = "none";
          pendingLatLng = null;
        });

        document.getElementById("btn-location-react").addEventListener("click", () => {
          if (!navigator.geolocation) return alert("Geolocalización no disponible");
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              mapRef.current.setView([pos.coords.latitude, pos.coords.longitude], 14);
            },
            () => alert("No se pudo obtener la ubicación")
          );
        });

        document.getElementById("btn-export-react").addEventListener("click", () => {
          const data = markerObjs.map((m) => ({ id: m._id, type: m.type, label: m.label, lat: m.getLatLng().lat, lng: m.getLatLng().lng, createdAt: m.createdAt }));
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "mapa-marcadores.json";
          a.click();
          URL.revokeObjectURL(url);
        });

        document.getElementById("importFile-react").addEventListener("change", function (e) {
          const f = e.target.files[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = function (ev) {
            try {
              const data = JSON.parse(ev.target.result);
              if (!Array.isArray(data)) throw new Error("JSON inválido: debe ser un arreglo");
              data.forEach((d) => {
                const norm = {
                  id: d.id || Date.now() + Math.floor(Math.random() * 1000),
                  type: d.type || "parcela",
                  label: d.label || (d.type === "colmena" ? "colmena" : "parcela no identificada"),
                  lat: Number(d.lat),
                  lng: Number(d.lng),
                  createdAt: d.createdAt || new Date().toISOString(),
                };
                addMarkerToMap(norm, false);
              });
              saveAllLocal();
            } catch (err) {
              alert("Error al importar JSON: " + err.message);
            }
          };
          reader.readAsText(f);
          e.target.value = "";
        });

        // expose clearAll for debugging
        function clearAllMarkers() {
          if (!confirm("¿Eliminar todos los marcadores?")) return;
          markerObjs.slice().forEach((m) => removeMarker(m._id));
          localStorage.removeItem(storageKey);
          refreshListUI();
        }
        document.getElementById("btn-clearall-react").addEventListener("click", clearAllMarkers);

        // Email button
        document.getElementById("btn-email-react")?.addEventListener("click", () => {
          const data = markerObjs.map((m) => `Etiqueta: ${m.label} | Tipo: ${m.type} | Lat: ${m.getLatLng().lat.toFixed(6)} | Lng: ${m.getLatLng().lng.toFixed(6)}`).join("%0D%0A");
          const subject = encodeURIComponent("Datos de marcadores del mapa");
          const body = encodeURIComponent(data || "Sin marcadores");
          window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });

        setLoaded(true);
        setMarkersCount(markerObjs.length);
      } catch (err) {
        console.error("Error cargando Leaflet:", err);
      }
    })();

    return () => {
      cancelled = true;
      // cleanup map
      if (mapRef.current) {
        try {
          mapRef.current.off();
          mapRef.current.remove();
        } catch (e) {
          // ignore
        }
        mapRef.current = null;
      }
    };
  }, []);

  // helper UI markup (React) — the map container is manipulated by Leaflet
  return (
    <div style={{ height: "100vh", position: "relative", fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial" }}>
      <div style={{ position: "absolute", left: 12, top: 12, zIndex: 1000, background: "rgba(255,255,255,0.95)", padding: 10, borderRadius: 8, boxShadow: "0 2px 8px rgba(0,0,0,.12)", display: "flex", gap: 8, alignItems: "center" }}>
        <strong>Mapa — colmenas y parcelas</strong>
        <button id="btn-location-react" className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#fff", cursor: "pointer" }}>Ir a mi ubicación</button>
        <button id="btn-export-react" className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#fff", cursor: "pointer" }}>Exportar JSON</button>
        <button id="btn-clearall-react" className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#fff", cursor: "pointer" }}>Eliminar todos</button>
        <button id="btn-email-react" className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#fff", cursor: "pointer" }}>Enviar Email</button>
        <label className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#fff", cursor: "pointer" }}>
          Importar JSON
          <input id="importFile-react" type="file" accept="application/json" style={{ display: "none" }} />
        </label>
        <div style={{ marginLeft: "auto", fontSize: 13, color: "#555" }}>Haz click en el mapa para agregar un punto</div>
      </div>

      <div id="map-react" ref={containerRef} style={{ height: "100%" }} />

      <div id="listPanel-react" style={{ position: "absolute", right: 12, top: 12, zIndex: 1000, background: "rgba(255,255,255,0.95)", padding: 10, borderRadius: 8, maxHeight: "70vh", overflow: "auto", width: 260, boxShadow: "0 2px 8px rgba(0,0,0,.12)" }}>
        <strong>Marcadores guardados ({markersCount})</strong>
        <div id="markerList-react" style={{ marginTop: 8 }} />
      </div>

      {/* Modal-like small panel */}
      <div id="addModal-react" style={{ display: "none", position: "fixed", left: "50%", transform: "translateX(-50%)", bottom: 24, zIndex: 1200, background: "#fff", padding: 12, borderRadius: 8, boxShadow: "0 6px 20px rgba(0,0,0,.18)", width: 340 }}>
        <div><strong>Agregar punto</strong></div>
        <div id="coordsText-react" style={{ fontSize: 13, color: "#444", marginTop: 6 }}></div>
        <div style={{ marginTop: 8, display: "flex", gap: 8, alignItems: "center" }}>
          <label><input name="type-react" type="radio" value="colmena" defaultChecked /> Colmena</label>
          <label><input name="type-react" type="radio" value="parcela" /> Parcela no identificada</label>
        </div>
        <div style={{ marginTop: 8 }}>
          <input id="labelInput-react" placeholder="Etiqueta (opcional)" style={{ width: "100%", padding: 6, borderRadius: 6, border: "1px solid #ddd" }} />
        </div>
        <div style={{ display: "flex", gap: 8, justifyContent: "flex-end", marginTop: 10 }}>
          <button id="cancelAdd-react" className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#fff", cursor: "pointer" }}>Cancelar</button>
          <button id="saveAdd-react" className="btn" style={{ padding: "6px 10px", borderRadius: 6, border: "1px solid #ddd", background: "#0ea5a4", color: "#fff", cursor: "pointer" }}>Guardar</button>
        </div>
      </div>
    </div>
  );
}
