<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Mapa — Colmenas y Parcelas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

<style>
  body {
    margin: 0;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  }
  .btn {
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
    background: #fff;
    cursor: pointer;
  }
  #map {
    height: 100vh;
  }
  .panel {
    position: absolute;
    z-index: 1000;
    background: rgba(255,255,255,0.95);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,.12);
  }
  #topPanel {
    left: 12px;
    top: 12px;
    display: flex;
    gap: 8px;
    align-items: center;
  }
  #listPanel {
    right: 12px;
    top: 12px;
    width: 260px;
    max-height: 70vh;
    overflow: auto;
  }
  #addModal {
    display: none;
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: 24px;
    z-index: 1200;
    background: #fff;
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,.18);
    width: 340px;
  }
</style>

</head>
<body>

<!-- PANEL SUPERIOR -->
<div id="topPanel" class="panel">
  <strong>Mapa — colmenas y parcelas</strong>

  <button id="btn-location" class="btn">Ir a mi ubicación</button>
  <button id="btn-export" class="btn">Exportar JSON</button>
  <button id="btn-clearall" class="btn">Eliminar todos</button>
  <button id="btn-email" class="btn">Enviar Email</button>

  <label class="btn">
    Importar JSON
    <input id="importFile" type="file" accept="application/json" style="display:none">
  </label>

  <div style="margin-left:auto; font-size:13px; color:#555;">
    Haz click en el mapa para agregar un punto
  </div>
</div>

<!-- MAPA -->
<div id="map"></div>

<!-- LISTA LATERAL -->
<div id="listPanel" class="panel">
  <strong id="countTitle">Marcadores guardados (0)</strong>
  <div id="markerList" style="margin-top:8px"></div>
</div>

<!-- MODAL PARA AGREGAR MARCADOR -->
<div id="addModal">
  <div><strong>Agregar punto</strong></div>
  <div id="coordsText" style="font-size:13px; margin-top:6px;"></div>

  <div style="margin-top:8px; display:flex; gap:8px;">
    <label><input name="type" type="radio" value="colmena" checked> Colmena</label>
    <label><input name="type" type="radio" value="parcela"> Parcela no identificada</label>
  </div>

  <div style="margin-top:8px;">
    <input id="labelInput" placeholder="Etiqueta (opcional)" 
           style="width:100%; padding:6px; border-radius:6px; border:1px solid #ddd;">
  </div>

  <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
    <button id="cancelAdd" class="btn">Cancelar</button>
    <button id="saveAdd" class="btn" style="background:#0ea5a4; color:#fff;">Guardar</button>
  </div>
</div>

<!-- LEAFLET JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ---------------------------------------------------------
   VERSION HTML — FUNCIONALIDAD COMPLETA
   --------------------------------------------------------- */

const storageKey = "map_markers_html_v1";
let map;
let pendingLatLng = null;
const markerObjs = [];

/* ICONOS */
const svgColmena = encodeURIComponent(
  "<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><path fill='%23F59E0B' d='M12 2C8.13 2 5 5.13 5 9c0 3.87 7 13 7 13s7-9.13 7-13c0-3.87-3.13-7-7-7z'/></svg>"
);
const svgParcela = encodeURIComponent(
  "<svg xmlns='http://www.w3.org/2000/svg' width='40' height='40'><rect rx='4' ry='4' width='20' height='14' x='2' y='5' fill='%239CA3AF'/></svg>"
);

const iconColmena = L.icon({
  iconUrl: "data:image/svg+xml;utf8," + svgColmena,
  iconSize: [28, 28],
  iconAnchor: [14, 28],
});
const iconParcela = L.icon({
  iconUrl: "data:image/svg+xml;utf8," + svgParcela,
  iconSize: [28, 28],
  iconAnchor: [14, 28],
});

/* INICIALIZAR MAPA */
map = L.map("map").setView([-34.6037, -58.3816], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* UTILIDADES */
function saveAllLocal() {
  const data = markerObjs.map(m => ({
    id: m._id,
    type: m.type,
    label: m.label,
    lat: m.getLatLng().lat,
    lng: m.getLatLng().lng,
    createdAt: m.createdAt
  }));
  localStorage.setItem(storageKey, JSON.stringify(data));
  refreshListUI();
}

function refreshListUI() {
  const list = document.getElementById("markerList");
  const countTitle = document.getElementById("countTitle");

  list.innerHTML = "";
  countTitle.textContent = `Marcadores guardados (${markerObjs.length})`;

  if (markerObjs.length === 0) {
    list.innerHTML = "<div class='small'>(sin marcadores)</div>";
    return;
  }

  markerObjs.forEach(m => {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.justifyContent = "space-between";
    item.style.marginBottom = "6px";

    const left = document.createElement("div");
    left.innerHTML = `<strong>${m.label}</strong><br><span style="font-size:12px">${m.type}</span>`;

    const right = document.createElement("div");
    const btnZoom = document.createElement("button");
    btnZoom.textContent = "Ir";
    btnZoom.className = "btn";
    btnZoom.onclick = () => {
      map.setView(m.getLatLng(), 16);
      m.openPopup();
    };

    const btnDel = document.createElement("button");
    btnDel.textContent = "Eliminar";
    btnDel.className = "btn";
    btnDel.onclick = () => removeMarker(m._id);

    right.appendChild(btnZoom);
    right.appendChild(btnDel);

    item.appendChild(left);
    item.appendChild(right);
    list.appendChild(item);
  });
}

function addMarkerToMap(data, persist = true) {
  const icon = data.type === "colmena" ? iconColmena : iconParcela;
  const m = L.marker([data.lat, data.lng], { icon }).addTo(map);

  m.type = data.type;
  m.label = data.label;
  m.createdAt = data.createdAt || new Date().toISOString();
  m._id = data.id || Date.now() + Math.floor(Math.random() * 1000);

  m.bindPopup(`
    <strong>${m.label}</strong><br>
    ${m.type}<br>
    Lat: ${m.getLatLng().lat.toFixed(6)}<br>
    Lng: ${m.getLatLng().lng.toFixed(6)}<br><br>
    <button onclick="removeMarker(${m._id})" class="btn">Eliminar</button>
  `);

  markerObjs.push(m);
  if (persist) saveAllLocal();
  return m;
}

function removeMarker(id) {
  const idx = markerObjs.findIndex(x => x._id === id);
  if (idx !== -1) {
    map.removeLayer(markerObjs[idx]);
    markerObjs.splice(idx, 1);
    saveAllLocal();
  }
}

/* MAP CLICK → MOSTRAR MODAL */
map.on("click", e => {
  pendingLatLng = e.latlng;
  document.getElementById("coordsText").textContent =
    `Lat: ${e.latlng.lat.toFixed(6)} — Lng: ${e.latlng.lng.toFixed(6)}`;
  document.getElementById("addModal").style.display = "block";
});

/* CANCELAR */
document.getElementById("cancelAdd").onclick = () => {
  pendingLatLng = null;
  document.getElementById("addModal").style.display = "none";
};

/* GUARDAR */
document.getElementById("saveAdd").onclick = () => {
  if (!pendingLatLng) return;

  const type = document.querySelector('input[name="type"]:checked').value;
  const label = document.getElementById("labelInput").value.trim() ||
    (type === "colmena" ? "colmena" : "parcela no identificada");

  addMarkerToMap({
    id: Date.now() + Math.floor(Math.random() * 1000),
    type,
    label,
    lat: pendingLatLng.lat,
    lng: pendingLatLng.lng
  });

  document.getElementById("addModal").style.display = "none";
  pendingLatLng = null;
};

/* IMPORTAR JSON */
document.getElementById("importFile").addEventListener("change", function (e) {
  const f = e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = ev => {
    try {
      const arr = JSON.parse(ev.target.result);
      arr.forEach(a => addMarkerToMap(a, false));
      saveAllLocal();
    } catch (err) {
      alert("Error al importar JSON: " + err);
    }
  };
  reader.readAsText(f);
  e.target.value = "";
});

/* EXPORTAR JSON */
document.getElementById("btn-export").onclick = () => {
  const data = markerObjs.map(m => ({
    id: m._id, type: m.type, label: m.label,
    lat: m.getLatLng().lat, lng: m.getLatLng().lng,
    createdAt: m.createdAt
  }));
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "mapa-marcadores.json";
  a.click();
  URL.revokeObjectURL(url);
};

/* LIMPIAR TODO */
document.getElementById("btn-clearall").onclick = () => {
  if (!confirm("Eliminar todos los marcadores?")) return;
  markerObjs.slice().forEach(m => removeMarker(m._id));
  localStorage.removeItem(storageKey);
  refreshListUI();
};

/* ENVIAR EMAIL */
document.getElementById("btn-email").onclick = () => {
  const data = markerObjs
    .map(m => `Etiqueta: ${m.label} | Tipo: ${m.type} | Lat: ${m.getLatLng().lat} | Lng: ${m.getLatLng().lng}`)
    .join("%0D%0A");

  window.location.href = `mailto:?subject=Datos%20del%20mapa&body=${data}`;
};

/* UBICACIÓN */
document.getElementById("btn-location").onclick = () => {
  if (!navigator.geolocation) return alert("Geolocalización no disponible");
  navigator.geolocation.getCurrentPosition(
    pos => map.setView([pos.coords.latitude, pos.coords.longitude], 14),
    () => alert("No se pudo obtener ubicación")
  );
};

/* CARGAR MARCADORES DE LOCALSTORAGE */
(function loadSaved() {
  try {
    const raw = localStorage.getItem(storageKey);
    if (!raw) return;
    const arr = JSON.parse(raw);
    arr.forEach(a => addMarkerToMap(a, false));
    refreshListUI();
  } catch (err) {
    console.error("Error cargando marcadores guardados", err);
  }
})();
</script>

</body>
</html>
